-- ----------------------------------------------
-- ----------------------------------------------
-- ------ YCCN: thống kê số liệu kinh doanh -----

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `solieukinhdoanh`()
    NO SQL
begin
SELECT 'Tổng số lớp đang mở:' as ' ';
	SELECT COUNT(lophoc.MaLH) AS So_Lop_Mo
    FROM lophoc
    WHERE lophoc.Ngayketthuc > CURRENT_TIME();

SELECT 'Tổng số lớp đang mở của mỗi khóa học:' as ' ';
	SELECT khoahoc.MaKH, khoahoc.Ten, COUNT(lophoc.MaLH) AS So_Lop_Mo
    FROM khoahoc JOIN lophoc ON khoahoc.MaKH = lophoc.khoahocMaKH
    WHERE lophoc.Ngayketthuc < CURRENT_TIME()
    GROUP BY khoahoc.MaKH;
    
SELECT 'Trung bình số học viên đăng ký mỗi ngày:' as ' ';
    SELECT (COUNT(DISTINCT dangky.hocvienMaHV) / (max(date(dangky.Ngaydangky)) - MIN(date(dangky.Ngaydangky)))) as Trung_Binh_HV
    FROM dangky;
    
SELECT 'Trung bình số lượt đăng ký mỗi ngày:' as ' ';
    SELECT (COUNT(dangky.hocvienMaHV) / (max(date(dangky.Ngaydangky)) - MIN(date(dangky.Ngaydangky)))) as Trung_Binh_Luot_Dangky
    FROM dangky;

SELECT 'Tổng số học viên:' as ' ';
	SELECT COUNT(DISTINCT dangky.hocvienMaHV)
    FROM dangky;

SELECT 'Tổng số học viên ở mỗi chi nhánh:' as ' ';
	SELECT chinhanh.MaCN, chinhanh.Ten, COUNT(DISTINCT dangky.hocvienMaHV) AS So_Hoc_Vien
    FROM chinhanh JOIN lophoc ON chinhanh.MaCN = lophoc.chinhanhMaCN JOIN dangky ON lophoc.MaLH = dangky.lophocMaLH
    GROUP BY chinhanh.MaCN;
end$$
DELIMITER ;


-- -------------------------------------------------------
-- -------------------------------------------------------
-- ------ YCCN: Xem danh sách lớp do GV/TG phụ trách -----


	-- --------- Bảng tạm 1: Trả về danh sách giáo viên/trợ giảng của các lớp do một giáo viên/trợ giảng phụ trách -----

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `xemdanhsachlop_GV_TG_temp`(IN `maNV` VARCHAR(255), IN `type` INT(4) UNSIGNED)
BEGIN
	CASE type
    WHEN 0 THEN
    SELECT lophoc.MaLH, giangday.giaovienNhanvien AS Giao_Vien
    FROM lophoc JOIN giangday ON lophoc.MaLH = giangday.lophocMaLH LEFT JOIN hotro ON hotro.lophocMaLH = lophoc.MaLH
    WHERE lophoc.MaLH IN (
        SELECT giangday.lophocMaLH
        FROM giangday
        WHERE giangday.giaovienNhanvien = maNV
		)
    OR lophoc.MaLH IN (
        SELECT hotro.lophocMaLH
        FROM hotro
        WHERE hotro.trogiangNhanvien = maNV
        )
    GROUP BY lophoc.MaLH, giangday.giaovienNhanvien
    ORDER BY lophoc.MaLH;
    
    WHEN 1 THEN
    SELECT lophoc.MaLH, hotro.trogiangNhanvien AS Tro_Giang
    FROM lophoc JOIN giangday ON lophoc.MaLH = giangday.lophocMaLH LEFT JOIN hotro ON hotro.lophocMaLH = lophoc.MaLH
    WHERE lophoc.MaLH IN (
        SELECT giangday.lophocMaLH
        FROM giangday
        WHERE giangday.giaovienNhanvien = maNV
		)
    OR lophoc.MaLH IN (
        SELECT hotro.lophocMaLH
        FROM hotro
        WHERE hotro.trogiangNhanvien = maNV
        )
    GROUP BY lophoc.MaLH, hotro.trogiangNhanvien
    ORDER BY lophoc.MaLH;
    END CASE;
END$$
DELIMITER ;

	-- --------- Bảng tạm 2: Trả về thời khóa biểu các lớp do một giáo viên/trợ giảng phụ trách -----

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `xemdanhsachlop_GV_TG_tkb`(IN `maNV` VARCHAR(255))
BEGIN
SELECT thoikhoabieu_lh.lophocMaLH, thoikhoabieu_lh.Ngay, thoikhoabieu_lh.Giobatdau, thoikhoabieu_lh.Gioketthuc
FROM thoikhoabieu_lh
WHERE thoikhoabieu_lh.lophocMaLH IN (
        SELECT giangday.lophocMaLH
        FROM giangday
        WHERE giangday.giaovienNhanvien = maNV
		)
OR thoikhoabieu_lh.lophocMaLH IN (
        SELECT hotro.lophocMaLH
        FROM hotro
        WHERE hotro.trogiangNhanvien = maNV
        )
ORDER BY thoikhoabieu_lh.lophocMaLH;
END$$
DELIMITER ;

	-- --------------------------- 	BẢNG CHÍNH ---------------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `xemdanhsachlop_GV_TG`(IN `maNV` VARCHAR(255))
BEGIN
	SELECT 'Các lớp mà bạn phụ trách là:' AS ' ';
	CASE LEFT(maNV,2)
    WHEN 'GV' THEN
        SELECT lophoc.MaLH, lophoc.Ngaybatdau, lophoc.Ngayketthuc, lophoc.Siso, lophoc.chinhanhMaCN, lophoc.khoahocMaKH, khoahoc.Ten
        FROM lophoc JOIN giangday ON lophoc.MaLH = giangday.lophocMaLH JOIN khoahoc ON lophoc.khoahocMaKH = khoahoc.MaKH
        WHERE giangday.giaovienNhanvien = maNV;
    WHEN 'TG' THEN
    	SELECT lophoc.MaLH, lophoc.Ngaybatdau, lophoc.Ngayketthuc, lophoc.Siso, lophoc.chinhanhMaCN, lophoc.khoahocMaKH, khoahoc.Ten
        FROM lophoc JOIN hotro ON lophoc.MaLH = hotro.lophocMaLH JOIN khoahoc ON lophoc.khoahocMaKH = khoahoc.MaKH
        WHERE hotro.trogiangNhanvien = maNV;
    END CASE;
    -- -----------------    
    SELECT 'Danh sách giáo viên của các lớp' AS '';
	call xemdanhsachlop_GV_TG_temp(maNV,0);
    SELECT 'Danh sách trợ giảng của các lớp' AS '';
    CALL xemdanhsachlop_GV_TG_temp(maNV,1);

    -- --------------------------------
    SELECT 'Thời khóa biểu của các lớp:' AS '';
    CALL xemdanhsachlop_GV_TG_tkb(maNV);
    
END$$
DELIMITER ;



-- ----------------------------------------------------------------------
-- ----------------------------------------------------------------------
-- ------ YCCN: Xem danh sách học viên của 1 lớp do GV/TG phụ trách -----

	------------ Bảng tạm 1: Danh sách học viên của 1 lớp học -------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `xemdanhsachhocvien`(IN `maLH` VARCHAR(255))
BEGIN
SELECT hocvien.MaHV, hocvien.Ho, hocvien.Tendem, hocvien.Ten, (year(CURRENT_TIME()) - hocvien.Namsinh) as Tuoi
FROM hocvien JOIN dangky ON dangky.hocvienMaHV = hocvien.MaHV
WHERE dangky.lophocMaLH = maLH;
END$$
DELIMITER ;

	------------ Bảng tạm 2: Danh sách lớp học do một giáo viên/trợ giảng phụ trách -----------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `danhsachlop_phutrach`(IN `maNV` VARCHAR(255))
BEGIN 
SELECT lophoc.MaLH, lophoc.khoahocMaKH, khoahoc.Ten
FROM lophoc JOIN khoahoc ON lophoc.khoahocMaKH = khoahoc.MaKH
WHERE lophoc.MaLH IN(
    SELECT giangday.lophocMaLH
    FROM giangday
    WHERE giangday.giaovienNhanvien = maNV
    )
OR lophoc.MaLH IN(
    SELECT hotro.lophocMaLH
    FROM hotro
    WHERE hotro.trogiangNhanvien = maNV
    );
END$$
DELIMITER ;

	---------------------BẢNG CHÍNH---------------------------------	

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `xemdanhsachhocvien_GV_TG`(IN `maNV` VARCHAR(255), IN `maLH` VARCHAR(255))
BEGIN
CASE LEFT(maNV,2)
WHEN 'GV' THEN
	IF (maLH IN (
        SELECT giangday.lophocMaLH
        FROM giangday
        WHERE giangday.giaovienNhanvien = maNV
        )
    ) THEN CALL xemdanhsachhocvien(maLH);
    ELSE 
    SELECT 'Đây không phải lớp do bạn phụ trách, vui lòng nhập lại. Sau đây là các lớp do bạn phụ trách' AS '';
    CALL danhsachlop_phutrach(maNV);
    END IF;


WHEN 'TG' THEN 
	IF (maLH IN (
        SELECT hotro.lophocMaLH
        FROM hotro
        WHERE hotro.trogiangNhanvien = maNV
        )
    ) THEN CALL xemdanhsachhocvien(maLH);
    ELSE 
    SELECT 'Đây không phải lớp do bạn phụ trách, vui lòng nhập lại. Sau đây là các lớp do bạn phụ trách' AS '';
    CALL danhsachlop_phutrach(maNV);
    END IF;

END CASE;
END$$
DELIMITER ;

